name: Build, Test, and Push Docker Image

on:
  push:
    branches:
      - main  # Run this workflow on push to main branch

jobs:
  build-test-push:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: your-dockerhub-username/flask-app
      TAG: latest

    steps:
      - name: ⬇️ Checkout code
        uses: actions/checkout@v4

      - name: 🔐 Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 🛠️ Build Docker image
        run: |
          docker build -t $IMAGE_NAME:$TAG .

      - name: 🧪 Run and test Docker container
        run: |
          docker run -d -p 5000:5000 --name test_container $IMAGE_NAME:$TAG
          sleep 5  # wait for Flask to start
          RESPONSE=$(curl -s http://localhost:5000)
          echo "Response from container: $RESPONSE"
          if [[ "$RESPONSE" != "Hello from Flask in Docker!" ]]; then
            echo "❌ Test failed!"
            docker logs test_container
            docker stop test_container && docker rm test_container
            exit 1
          fi
          echo "✅ Test passed."
          docker stop test_container && docker rm test_container

      - name: 🚀 Push Docker image to Docker Hub
        run: docker push $IMAGE_NAME:$TAG
